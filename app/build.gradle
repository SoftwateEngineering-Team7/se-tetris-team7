
plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'jacoco'
}

repositories {
    mavenCentral()
}

sourceSets {
  main {
    resources {
        // ë¦¬ì†ŒìŠ¤ ë””ë ‰í„°ë¦¬ 2ê³³ì„ ëª¨ë‘ í´ë˜ìŠ¤íŒ¨ìŠ¤ì— í¬í•¨
      srcDirs = ['src/main/resources', 'src/main/java']

      // java í´ë”ì—ì„œ .fxml/.css/.pngë§Œ í¬í•¨í•˜ê³  .javaëŠ” ì œì™¸
      include '**/*.fxml', '**/*.css', '**/*.png'
      exclude '**/*.java'
    }
  }
}

dependencies {
    implementation libs.guava
    testImplementation libs.junit
    // ê°œë³„ JavaFX ì˜ì¡´ì„±ì€ í•„ìš” ì—†ìŒ â€” ì•„ë˜ javafx ë¸”ë¡ì´ ì²˜ë¦¬
    // TestFX for JavaFX GUI testing
    testImplementation "org.testfx:testfx-core:4.0.18"
    testImplementation "org.testfx:testfx-junit:4.0.18"
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    mainClass = 'org.tetris.App'
}

javafx {
    version = '21'
    modules = [ 'javafx.controls', 'javafx.fxml' ]
}

jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        csv.required = true
        html.required = true
    }
    classDirectories.setFrom(files(classDirectories.files.collect {
        fileTree(dir: it, exclude: [
        ])
    }))
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    violationRules {
        rule {
            limit { minimum = 0.6 }
        }
    }
}

test {
    useJUnit()
    ignoreFailures = true
}

tasks.register('packageApp', Exec) {
    dependsOn build
    group = 'distribution'
version = '1.0.0'

    description = 'Build executable package with jpackage'

    doFirst {
        println "ğŸ“¦ Packaging JavaFX app with jpackage..."
    }

    // OSë³„ë¡œ ë‹¤ë¥´ê²Œ ì„¤ì • ê°€ëŠ¥
    def outputDir = "${buildDir}/dist"
    def iconFile = "src/main/resources/tetris.icns" // macOSë¼ë©´ .icns, windowsëŠ” .ico ì‚¬ìš©
    def mainJar = "${buildDir}/libs/${project.name}-${version}.jar"

    commandLine 'jpackage',
            '--name', 'Team7 Tetris',
            '--input', "${buildDir}/libs",
            '--main-jar', "${project.name}-${version}.jar",
            '--main-class', 'org.tetris.App',
            '--icon', iconFile,
            '--type', 'dmg',             // macOSëŠ” 'dmg' ë˜ëŠ” 'pkg', LinuxëŠ” 'deb' ë˜ëŠ” 'rpm', WindowsëŠ” 'exe' ë˜ëŠ” 'msi'
            '--dest', outputDir,
            '--app-version', '1.0',
            '--vendor', 'MyStudio'
}