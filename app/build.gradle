
plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
    id 'jacoco'
}

repositories {
    mavenCentral()
}

sourceSets {
  main {
    resources {
        // ë¦¬ì†ŒìŠ¤ ë””ë ‰í„°ë¦¬ 2ê³³ì„ ëª¨ë‘ í´ë˜ìŠ¤íŒ¨ìŠ¤ì— í¬í•¨
      srcDirs = ['src/main/resources', 'src/main/java']

      // java í´ë”ì—ì„œ .fxml/.css/.pngë§Œ í¬í•¨í•˜ê³  .javaëŠ” ì œì™¸
      include '**/*.fxml', '**/*.css', '**/*.png'
      exclude '**/*.java'
    }
  }
}

dependencies {
    implementation libs.guava
    testImplementation libs.junit
    // ê°œë³„ JavaFX ì˜ì¡´ì„±ì€ í•„ìš” ì—†ìŒ â€” ì•„ë˜ javafx ë¸”ë¡ì´ ì²˜ë¦¬
    // TestFX for JavaFX GUI testing
    testImplementation "org.testfx:testfx-core:4.0.18"
    testImplementation "org.testfx:testfx-junit:4.0.18"
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    mainClass = 'org.tetris.App'
}

javafx {
    version = '21'
    modules = [ 'javafx.controls', 'javafx.fxml' ]
}

// JAR íŒŒì¼ì— Main-Class ë° Class-Path ì„¤ì •
jar {
    manifest {
        attributes(
            'Main-Class': 'org.tetris.Launcher',  // Launcherë¥¼ í†µí•´ JavaFX ëª¨ë“ˆ ì²´í¬ ìš°íšŒ
            'Class-Path': configurations.runtimeClasspath.collect { it.name }.join(' ')
        )
    }
    
    // ëª¨ë“  ì˜ì¡´ì„±ì„ JARì— í¬í•¨ (Fat JAR)
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        csv.required = true
        html.required = true
    }
    classDirectories.setFrom(files(classDirectories.files.collect {
        fileTree(dir: it, exclude: [
        ])
    }))
}

jacocoTestCoverageVerification {
    dependsOn jacocoTestReport
    violationRules {
        rule {
            limit { minimum = 0.6 }
        }
    }
}

test {
    useJUnit()
    
    if (System.getenv("CI") != null) {
        // CI í™˜ê²½ì—ì„œëŠ” JavaFX GUI í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ
        println "âš ï¸ CI í™˜ê²½ ê°ì§€ â€” JavaFX UI í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ"
        include '**/model/**'
        exclude '**/controller/**'
    } else{
        // ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰, ì‹¤íŒ¨í•´ë„ ë¹Œë“œ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
        include '**/model/**', '**/controller/**'
        ignoreFailures = true
    }
    
    // ë¹Œë“œ ì‹œ í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ (-x test ì˜µì…˜ ì—†ì´ë„ ìŠ¤í‚µ)
    onlyIf { gradle.startParameter.taskNames.contains('test') }
}


tasks.register('packageApp', Exec) {
    dependsOn jar
    group = 'distribution'

    description = 'Build executable package with jpackage'

    doFirst {
        println "ğŸ“¦ Packaging JavaFX app with jpackage..."
    }

    // OSë³„ë¡œ ë‹¤ë¥´ê²Œ ì„¤ì • ê°€ëŠ¥
    def outputDir = "${buildDir}/dist"
    
    // macOSìš© ì„¤ì •
    def iconFile = "src/main/resources/tetris.icns"
    def packageType = 'dmg'
    
    // Windowsìš© ì„¤ì • (Windowsì—ì„œ ë¹Œë“œ ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ)
    // def iconFile = "src/main/resources/tetris.ico"
    // def packageType = 'app-image'

    commandLine 'jpackage',
            '--name', 'Team7 Tetris',
            '--input', "${buildDir}/libs",
            '--main-jar', 'app.jar',
            '--main-class', 'org.tetris.Launcher',  // Launcherë¥¼ í†µí•´ JavaFX ëª¨ë“ˆ ì²´í¬ ìš°íšŒ
            '--type', packageType,
            '--icon', iconFile,
            '--dest', outputDir,
            '--app-version', '2.0',
            '--vendor', 'Team7'
}